<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>1 Weather Data Preparation and Wrangling | Welcome to the Documentation!</title>
  <meta name="description" content="I love documentation! Don’t you? :)" />
  <meta name="generator" content="bookdown 0.16 and GitBook 2.6.7" />

  <meta property="og:title" content="1 Weather Data Preparation and Wrangling | Welcome to the Documentation!" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="I love documentation! Don’t you? :)" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="1 Weather Data Preparation and Wrangling | Welcome to the Documentation!" />
  
  <meta name="twitter:description" content="I love documentation! Don’t you? :)" />
  

<meta name="author" content="Authors Names Here" />


<meta name="date" content="2019-12-19" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="index.html"/>

<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<script src="libs/elevate-section-attrs-2.0/elevate-section-attrs.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#hello-world"><i class="fa fa-check"></i>Hello World!</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="weather-data-preparation-and-wrangling.html"><a href="weather-data-preparation-and-wrangling.html"><i class="fa fa-check"></i><b>1</b> Weather Data Preparation and Wrangling</a>
<ul>
<li class="chapter" data-level="1.1" data-path="weather-data-preparation-and-wrangling.html"><a href="weather-data-preparation-and-wrangling.html#querying-epa-data-in-r"><i class="fa fa-check"></i><b>1.1</b> Querying EPA Data in R</a>
<ul>
<li class="chapter" data-level="1.1.1" data-path="weather-data-preparation-and-wrangling.html"><a href="weather-data-preparation-and-wrangling.html#getting-started"><i class="fa fa-check"></i><b>1.1.1</b> Getting Started</a></li>
<li class="chapter" data-level="1.1.2" data-path="weather-data-preparation-and-wrangling.html"><a href="weather-data-preparation-and-wrangling.html#selecting-timeframes-states-and-pollutantweather-variables"><i class="fa fa-check"></i><b>1.1.2</b> Selecting timeframes, states, and pollutant/weather variables</a></li>
<li class="chapter" data-level="1.1.3" data-path="weather-data-preparation-and-wrangling.html"><a href="weather-data-preparation-and-wrangling.html#sensor-locations-and-metadata"><i class="fa fa-check"></i><b>1.1.3</b> Sensor Locations and Metadata</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="weather-data-preparation-and-wrangling.html"><a href="weather-data-preparation-and-wrangling.html#querying-for-faa-data-in-r"><i class="fa fa-check"></i><b>1.2</b> Querying for FAA Data in R</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="weather-data-preparation-and-wrangling.html"><a href="weather-data-preparation-and-wrangling.html#simple-data-query"><i class="fa fa-check"></i><b>1.2.1</b> Simple Data Query</a></li>
<li class="chapter" data-level="1.2.2" data-path="weather-data-preparation-and-wrangling.html"><a href="weather-data-preparation-and-wrangling.html#selecting-which-sensors-to-query"><i class="fa fa-check"></i><b>1.2.2</b> Selecting Which Sensors to Query</a></li>
<li class="chapter" data-level="1.2.3" data-path="weather-data-preparation-and-wrangling.html"><a href="weather-data-preparation-and-wrangling.html#querying-weather-data-for-multiple-stations"><i class="fa fa-check"></i><b>1.2.3</b> Querying Weather Data for Multiple Stations</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="weather-data-preparation-and-wrangling.html"><a href="weather-data-preparation-and-wrangling.html#using-weather-data-to-interpolate-a-raster-surface"><i class="fa fa-check"></i><b>1.3</b> Using Weather Data to Interpolate a Raster Surface</a>
<ul>
<li class="chapter" data-level="1.3.1" data-path="weather-data-preparation-and-wrangling.html"><a href="weather-data-preparation-and-wrangling.html#your-first-interpolation"><i class="fa fa-check"></i><b>1.3.1</b> Your First Interpolation</a></li>
<li class="chapter" data-level="1.3.2" data-path="weather-data-preparation-and-wrangling.html"><a href="weather-data-preparation-and-wrangling.html#the-idw-workflow"><i class="fa fa-check"></i><b>1.3.2</b> The IDW Workflow</a></li>
</ul></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Welcome to the Documentation!</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="weather-data-preparation-and-wrangling" class="section level1" number="1">
<h1 number="1"><span class="header-section-number">1</span> Weather Data Preparation and Wrangling</h1>
<p>This project uses weather and pollution data from remotely sensed satellite imagery, but also ground based sensors maintained by the EPA and FAA to model air quality in the Midwest. Using the ground sensors, the team can determine how accurate the models are at predicting air quality. This chapter focuses on how weather and pollution data from ground sensors was downloaded and prepared for use in refining air quality models.</p>
<div id="querying-epa-data-in-r" class="section level2" number="1.1">
<h2 number="1.1"><span class="header-section-number">1.1</span> Querying EPA Data in R</h2>
<p>EPA data was seamlessly imported into R using a custom package, named <strong>epadata</strong>. The package takes advanatge of the <a href="https://aqs.epa.gov/aqsweb/documents/data_mart_welcome.html">EPA AQS DataMart API</a> to load data in R as data.frame objects with only a couple lines of code. It allows users to query for sensor data across multiple years, states, and air quality variables. Let’s get started by downloading the package, then we’ll do a walkthrough of the <strong>epadata</strong> package.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="weather-data-preparation-and-wrangling.html#cb3-1"></a>devtools<span class="op">::</span><span class="kw">install_url</span>(<span class="st">&#39;https://uchicago.box.com/shared/static/jwpi7l89t58lm1sukit2tvcdavs5sz5t.zip&#39;</span>, <span class="dt">quiet =</span> <span class="ot">TRUE</span>)</span>
<span id="cb3-2"><a href="weather-data-preparation-and-wrangling.html#cb3-2"></a><span class="kw">library</span>(epadata)</span></code></pre></div>
<div id="getting-started" class="section level3" number="1.1.1">
<h3 number="1.1.1"><span class="header-section-number">1.1.1</span> Getting Started</h3>
<p>This section describes the process for querying EPA sensor data using the <strong>epadata</strong> package. For more information on how each function works, please reference the package documentation.</p>
<div id="registering-for-an-api-key" class="section level4 unnumbered" number="">
<h4 class="unnumbered" number="">Registering for an API Key</h4>
<p>For first time users of the AQS DataMart API, you must first register your email to recieve an API key. (Users who already have a DataMart API key, please skep to the next step). The API key is a required input for all querying functions in the <strong>epadata</strong> package. Obtaining a key is made simple by calling the <em>API.signup()</em> function and inputting your own email address.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="weather-data-preparation-and-wrangling.html#cb4-1"></a><span class="kw">API.signup</span>(<span class="st">&#39;YourEmailHere@uchicago.edu&#39;</span>)</span></code></pre></div>
<p>Save your API key from the email confirmation for future reference. In case you don’t recieve an email, verify that your email address was typed correctly, and check your spam folder.</p>
</div>
<div id="your-first-data-query" class="section level4 unnumbered" number="">
<h4 class="unnumbered" number="">Your First Data Query</h4>
<p>Below, we’ll query for PM2.5 data across Indiana and Wisconsin for the years 2017 and 2018 using the <em>EPA.daily.summary()</em> function. This function will return a data.table containing a record of the daily average of the selected variable for all sensors with <strong>available</strong> data during the selected year and selected state.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="weather-data-preparation-and-wrangling.html#cb5-1"></a>PM25.data =<span class="st"> </span><span class="kw">EPA.daily.summary</span>(<span class="dt">email =</span> email,</span>
<span id="cb5-2"><a href="weather-data-preparation-and-wrangling.html#cb5-2"></a>                                  <span class="dt">key =</span> key,</span>
<span id="cb5-3"><a href="weather-data-preparation-and-wrangling.html#cb5-3"></a>                                  <span class="dt">year.range =</span> <span class="dv">2017</span><span class="op">:</span><span class="dv">2018</span>,</span>
<span id="cb5-4"><a href="weather-data-preparation-and-wrangling.html#cb5-4"></a>                                  <span class="dt">state.FIPS.list =</span> <span class="kw">list</span>(<span class="dv">18</span>, <span class="dv">55</span>), </span>
<span id="cb5-5"><a href="weather-data-preparation-and-wrangling.html#cb5-5"></a>                                  <span class="dt">pollutant.code =</span> <span class="dv">88502</span>)</span></code></pre></div>
<pre><code>## Querying API for pollutant 88502 between 20170101 and 20171231 in state 18</code></pre>
<pre><code>## Querying API for pollutant 88502 between 20180101 and 20181231 in state 18</code></pre>
<pre><code>## Querying API for pollutant 88502 between 20170101 and 20171231 in state 55</code></pre>
<pre><code>## Querying API for pollutant 88502 between 20180101 and 20181231 in state 55</code></pre>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="weather-data-preparation-and-wrangling.html#cb10-1"></a><span class="kw">head</span>(PM25.data)</span></code></pre></div>
<pre><code>##   state_code county_code site_number parameter_code poc latitude longitude
## 1         55         041        0007          88502   1   45.565  -88.8086
## 2         55         041        0007          88502   1   45.565  -88.8086
## 3         55         041        0007          88502   1   45.565  -88.8086
## 4         55         041        0007          88502   1   45.565  -88.8086
## 5         55         041        0007          88502   1   45.565  -88.8086
## 6         55         041        0007          88502   1   45.565  -88.8086
##   datum                              parameter sample_duration
## 1 NAD83 Acceptable PM2.5 AQI &amp; Speciation Mass         24 HOUR
## 2 NAD83 Acceptable PM2.5 AQI &amp; Speciation Mass         24 HOUR
## 3 NAD83 Acceptable PM2.5 AQI &amp; Speciation Mass         24 HOUR
## 4 NAD83 Acceptable PM2.5 AQI &amp; Speciation Mass         24 HOUR
## 5 NAD83 Acceptable PM2.5 AQI &amp; Speciation Mass         24 HOUR
## 6 NAD83 Acceptable PM2.5 AQI &amp; Speciation Mass         24 HOUR
##   pollutant_standard date_local            units_of_measure event_type
## 1                 NA 2017-01-01 Micrograms/cubic meter (LC)       None
## 2                 NA 2017-01-04 Micrograms/cubic meter (LC)       None
## 3                 NA 2017-01-07 Micrograms/cubic meter (LC)       None
## 4                 NA 2017-01-10 Micrograms/cubic meter (LC)       None
## 5                 NA 2017-01-13 Micrograms/cubic meter (LC)       None
## 6                 NA 2017-01-16 Micrograms/cubic meter (LC)       None
##   observation_count observation_percent validity_indicator arithmetic_mean
## 1                 1                 100                  Y             3.6
## 2                 1                 100                  Y             1.3
## 3                 1                 100                  Y             4.5
## 4                 1                 100                  Y             9.5
## 5                 1                 100                  Y             3.0
## 6                 1                 100                  Y             6.1
##   first_max_value first_max_hour aqi method_code
## 1             3.6              0  15         707
## 2             1.3              0   5         707
## 3             4.5              0  19         707
## 4             9.5              0  40         707
## 5             3.0              0  13         707
## 6             6.1              0  25         707
##                                                                         method
## 1 IMPROVE Module A with Cyclone Inlet-Teflon Filter, 2.2 sq. cm. - GRAVIMETRIC
## 2 IMPROVE Module A with Cyclone Inlet-Teflon Filter, 2.2 sq. cm. - GRAVIMETRIC
## 3 IMPROVE Module A with Cyclone Inlet-Teflon Filter, 2.2 sq. cm. - GRAVIMETRIC
## 4 IMPROVE Module A with Cyclone Inlet-Teflon Filter, 2.2 sq. cm. - GRAVIMETRIC
## 5 IMPROVE Module A with Cyclone Inlet-Teflon Filter, 2.2 sq. cm. - GRAVIMETRIC
## 6 IMPROVE Module A with Cyclone Inlet-Teflon Filter, 2.2 sq. cm. - GRAVIMETRIC
##   local_site_name                   site_address     state county          city
## 1      POTAWATOMI FIRE TOWER RD, POTAWATOMI SITE Wisconsin Forest Not in a city
## 2      POTAWATOMI FIRE TOWER RD, POTAWATOMI SITE Wisconsin Forest Not in a city
## 3      POTAWATOMI FIRE TOWER RD, POTAWATOMI SITE Wisconsin Forest Not in a city
## 4      POTAWATOMI FIRE TOWER RD, POTAWATOMI SITE Wisconsin Forest Not in a city
## 5      POTAWATOMI FIRE TOWER RD, POTAWATOMI SITE Wisconsin Forest Not in a city
## 6      POTAWATOMI FIRE TOWER RD, POTAWATOMI SITE Wisconsin Forest Not in a city
##   cbsa_code cbsa date_of_last_change
## 1        NA   NA          2018-10-12
## 2        NA   NA          2018-10-12
## 3        NA   NA          2018-10-12
## 4        NA   NA          2018-10-12
## 5        NA   NA          2018-10-12
## 6        NA   NA          2018-10-12</code></pre>
<p>Notice how for each each data request, you must specify which <strong>timeframe</strong> (year.range = 2017:2018), <strong>states</strong> (state.FIPS.list = list(18, 55)), and which <strong>pollutant/weather variable</strong> (pollutant.code = 88502) to query for. Inputting this data might not be strightforward at first, but the package has some other built-in functions to help you.</p>
</div>
</div>
<div id="selecting-timeframes-states-and-pollutantweather-variables" class="section level3" number="1.1.2">
<h3 number="1.1.2"><span class="header-section-number">1.1.2</span> Selecting timeframes, states, and pollutant/weather variables</h3>
<ul>
<li><strong>Timeframes</strong>: This is the simplest variable to select, as it is simply a number range representing the year. More granular timescales can be extracted from queried data if needed.</li>
</ul>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="weather-data-preparation-and-wrangling.html#cb12-1"></a>year.range =<span class="st"> </span><span class="dv">2014</span><span class="op">:</span><span class="dv">2018</span> <span class="co"># Query for data in years 2014, 2015, 2016, 2017, and 2018</span></span>
<span id="cb12-2"><a href="weather-data-preparation-and-wrangling.html#cb12-2"></a>year.range =<span class="st"> </span><span class="dv">2016</span><span class="op">:</span><span class="dv">2016</span> <span class="co"># Query for data in 2016 only</span></span></code></pre></div>
<ul>
<li><strong>States</strong>: You must input the state(s) <a href="https://en.wikipedia.org/wiki/Federal_Information_Processing_Standard_state_code">FIPS</a> code because the DataMart API uses this as a parimary key for all U.S. states.</li>
</ul>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="weather-data-preparation-and-wrangling.html#cb13-1"></a>state.FIPS.list =<span class="st"> </span><span class="kw">list</span>(<span class="dv">18</span>, <span class="dv">55</span>) <span class="co"># Query for data in Indiana (18) and Wisconsin (55)</span></span>
<span id="cb13-2"><a href="weather-data-preparation-and-wrangling.html#cb13-2"></a>state.FIPS.list =<span class="st"> </span><span class="kw">list</span>(<span class="dv">17</span>) <span class="co"># Query for data in Illinois (17) only.</span></span></code></pre></div>
<p>If you don’t know the FIPS code associated with the State you’re querying for, use the following function to find it. This function will return a data table containing the FIPS code for each State.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="weather-data-preparation-and-wrangling.html#cb14-1"></a>FIPS.codes =<span class="st"> </span><span class="kw">state.list</span>(email, key)</span>
<span id="cb14-2"><a href="weather-data-preparation-and-wrangling.html#cb14-2"></a></span>
<span id="cb14-3"><a href="weather-data-preparation-and-wrangling.html#cb14-3"></a><span class="kw">head</span>(FIPS.codes)</span></code></pre></div>
<pre><code>##   code value_represented
## 1   01           Alabama
## 2   02            Alaska
## 3   04           Arizona
## 4   05          Arkansas
## 5   06        California
## 6   08          Colorado</code></pre>
<ul>
<li><strong>Pollutant/Weather Variable</strong>: The EPA has a large bank of variables to choose from. Variables are first categorized as classes. A listing of available classes can be quried from the API as shown below. Each class has a unique code assigned to it.</li>
</ul>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="weather-data-preparation-and-wrangling.html#cb16-1"></a>class.codes =<span class="st"> </span><span class="kw">class.list</span>(email, key)</span>
<span id="cb16-2"><a href="weather-data-preparation-and-wrangling.html#cb16-2"></a></span>
<span id="cb16-3"><a href="weather-data-preparation-and-wrangling.html#cb16-3"></a><span class="kw">head</span>(class.codes)</span></code></pre></div>
<pre><code>##             code
## 1    AIRNOW MAPS
## 2            ALL
## 3 AQI POLLUTANTS
## 4      CORE_HAPS
## 5       CRITERIA
## 6       CSN DART
##                                                     value_represented
## 1 The parameters represented on AirNow maps (88101, 88502, and 44201)
## 2                                     Select all Parameters Available
## 3                                 Pollutants that have an AQI Defined
## 4                                          Urban Air Toxic Pollutants
## 5                                                 Criteria Pollutants
## 6     List of CSN speciation parameters to populate the STI DART tool</code></pre>
<p>Using your chosen class code, you can find the individual variables within each class. Alternatively, you can also query for all variables, but this is not recommended as the list is very large.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="weather-data-preparation-and-wrangling.html#cb18-1"></a>variable.codes<span class="fl">.1</span> =<span class="st"> </span><span class="kw">variable.list</span>(email, key, <span class="dt">class =</span> <span class="st">&#39;CORE_HAPS&#39;</span>) <span class="co"># Search for variables in the Urban Air Toxic Pollutants class.</span></span>
<span id="cb18-2"><a href="weather-data-preparation-and-wrangling.html#cb18-2"></a></span>
<span id="cb18-3"><a href="weather-data-preparation-and-wrangling.html#cb18-3"></a><span class="kw">head</span>(variable.codes<span class="fl">.1</span>)</span></code></pre></div>
<pre><code>##    code     value_represented
## 1 12103     Arsenic (TSP) STP
## 2 12105   Beryllium (TSP) STP
## 3 12110     Cadmium (TSP) STP
## 4 12112    Chromium (TSP) STP
## 5 12115 Chromium VI (TSP) STP
## 6 12128        Lead (TSP) STP</code></pre>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="weather-data-preparation-and-wrangling.html#cb20-1"></a>variable.codes<span class="fl">.2</span> =<span class="st"> </span><span class="kw">variable.list</span>(email, key, <span class="dt">class =</span> <span class="st">&#39;ALL&#39;</span>) <span class="co"># Returns all available EPA vairables. NB: This will create a very large data table and could take some time to load.</span></span></code></pre></div>
<div id="advanced-querying" class="section level4 unnumbered" number="">
<h4 class="unnumbered" number="">Advanced Querying</h4>
<ul>
<li><strong>Fetching Daily Summaries for Multiple Variables</strong> in a single query is not recommended. This is due to long processing times regardless of internet bandwidth/speed and large output data tables. However, you may choose to do this usign the <strong>apply</strong> family of functions, as shown below.</li>
</ul>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="weather-data-preparation-and-wrangling.html#cb21-1"></a>pollutant.codes =<span class="st"> </span><span class="kw">list</span>(<span class="dv">88502</span>, <span class="dv">81102</span>) <span class="co"># Two pollutant codes, one for each pollutant variable</span></span>
<span id="cb21-2"><a href="weather-data-preparation-and-wrangling.html#cb21-2"></a></span>
<span id="cb21-3"><a href="weather-data-preparation-and-wrangling.html#cb21-3"></a>pollutant.data =<span class="st"> </span><span class="kw">lapply</span>(pollutant.codes, <span class="dt">FUN =</span> <span class="cf">function</span>(x){</span>
<span id="cb21-4"><a href="weather-data-preparation-and-wrangling.html#cb21-4"></a>    <span class="kw">EPA.daily.summary</span>(<span class="dt">email =</span> email,</span>
<span id="cb21-5"><a href="weather-data-preparation-and-wrangling.html#cb21-5"></a>                      <span class="dt">key =</span> key,</span>
<span id="cb21-6"><a href="weather-data-preparation-and-wrangling.html#cb21-6"></a>                      <span class="dt">year.range =</span> <span class="dv">2017</span><span class="op">:</span><span class="dv">2018</span>,</span>
<span id="cb21-7"><a href="weather-data-preparation-and-wrangling.html#cb21-7"></a>                      <span class="dt">state.FIPS.list =</span> <span class="kw">list</span>(<span class="dv">18</span>, <span class="dv">55</span>), </span>
<span id="cb21-8"><a href="weather-data-preparation-and-wrangling.html#cb21-8"></a>                      <span class="dt">pollutant.code =</span> x) </span>
<span id="cb21-9"><a href="weather-data-preparation-and-wrangling.html#cb21-9"></a>    </span>
<span id="cb21-10"><a href="weather-data-preparation-and-wrangling.html#cb21-10"></a>}) <span class="op">%&gt;%</span><span class="st">  </span><span class="kw">do.call</span>(<span class="st">&quot;rbind&quot;</span>, .)</span>
<span id="cb21-11"><a href="weather-data-preparation-and-wrangling.html#cb21-11"></a></span>
<span id="cb21-12"><a href="weather-data-preparation-and-wrangling.html#cb21-12"></a><span class="co"># Verifying that multiple pollutant variables were chosen</span></span>
<span id="cb21-13"><a href="weather-data-preparation-and-wrangling.html#cb21-13"></a><span class="kw">unique</span>(pollutant.data<span class="op">$</span>parameter)</span></code></pre></div>
</div>
</div>
<div id="sensor-locations-and-metadata" class="section level3" number="1.1.3">
<h3 number="1.1.3"><span class="header-section-number">1.1.3</span> Sensor Locations and Metadata</h3>
<p>The <strong>epadata</strong> package also allows you to query for station location and other sensor-related metadata. The function below does this for you, and has a similar usage to the daily summary function.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="weather-data-preparation-and-wrangling.html#cb22-1"></a>sensors =<span class="st"> </span><span class="kw">EPA.monitor.locations</span>(<span class="dt">email =</span> email,</span>
<span id="cb22-2"><a href="weather-data-preparation-and-wrangling.html#cb22-2"></a>                                    <span class="dt">key =</span> key,</span>
<span id="cb22-3"><a href="weather-data-preparation-and-wrangling.html#cb22-3"></a>                                    <span class="dt">year.range =</span> <span class="dv">2017</span><span class="op">:</span><span class="dv">2018</span>,</span>
<span id="cb22-4"><a href="weather-data-preparation-and-wrangling.html#cb22-4"></a>                                    <span class="dt">state.FIPS.list =</span> <span class="kw">list</span>(<span class="dv">18</span>, <span class="dv">55</span>), </span>
<span id="cb22-5"><a href="weather-data-preparation-and-wrangling.html#cb22-5"></a>                                    <span class="dt">pollutant.code =</span> <span class="kw">list</span>(<span class="dv">88502</span>, <span class="dv">81102</span>))</span>
<span id="cb22-6"><a href="weather-data-preparation-and-wrangling.html#cb22-6"></a></span>
<span id="cb22-7"><a href="weather-data-preparation-and-wrangling.html#cb22-7"></a><span class="kw">plot</span>(sensors)</span></code></pre></div>
<p><img src="_main_files/figure-html/locations-1.png" width="672" /></p>
<p>By default, the function will return a spatial object. However, you can forego the spatial data component and keep only the attribute table by changing spatial to FALSE as shown below.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="weather-data-preparation-and-wrangling.html#cb23-1"></a>EPA.sensors.df =<span class="st"> </span><span class="kw">EPA.monitor.locations</span>(<span class="dt">email =</span> email,</span>
<span id="cb23-2"><a href="weather-data-preparation-and-wrangling.html#cb23-2"></a>                                    <span class="dt">key =</span> key,</span>
<span id="cb23-3"><a href="weather-data-preparation-and-wrangling.html#cb23-3"></a>                                    <span class="dt">year.range =</span> <span class="dv">2017</span><span class="op">:</span><span class="dv">2018</span>,</span>
<span id="cb23-4"><a href="weather-data-preparation-and-wrangling.html#cb23-4"></a>                                    <span class="dt">state.FIPS.list =</span> <span class="kw">list</span>(<span class="dv">18</span>, <span class="dv">55</span>), </span>
<span id="cb23-5"><a href="weather-data-preparation-and-wrangling.html#cb23-5"></a>                                    <span class="dt">pollutant.code =</span> <span class="kw">list</span>(<span class="dv">88502</span>, <span class="dv">81102</span>),</span>
<span id="cb23-6"><a href="weather-data-preparation-and-wrangling.html#cb23-6"></a>                                    <span class="dt">spatial =</span> <span class="ot">FALSE</span>)</span>
<span id="cb23-7"><a href="weather-data-preparation-and-wrangling.html#cb23-7"></a></span>
<span id="cb23-8"><a href="weather-data-preparation-and-wrangling.html#cb23-8"></a>EPA.sensors.df[<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>,]</span></code></pre></div>
<pre><code>##   state_code county_code site_number parameter_code poc
## 1         18         089        2004          88502   5
## 2         18         175        9000          88502   1
##                           parameter_name  open_date close_date
## 1 Acceptable PM2.5 AQI &amp; Speciation Mass 2004-01-04       &lt;NA&gt;
## 2 Acceptable PM2.5 AQI &amp; Speciation Mass 2001-03-08       &lt;NA&gt;
##   concurred_exclusions dominant_source measurement_scale measurement_scale_def
## 1                 &lt;NA&gt;            &lt;NA&gt;              &lt;NA&gt;                  &lt;NA&gt;
## 2                 &lt;NA&gt;            &lt;NA&gt;              &lt;NA&gt;                  &lt;NA&gt;
##   monitoring_objective last_method_code
## 1  POPULATION EXPOSURE              810
## 2   GENERAL/BACKGROUND              707
##                                                        last_method_description
## 1                                            Met One SASS Teflon - Gravimetric
## 2 IMPROVE Module A with Cyclone Inlet-Teflon Filter, 2.2 sq. cm. - GRAVIMETRIC
##   last_method_begin_date naaqs_primary_monitor qa_primary_monitor monitor_type
## 1             2004-01-04                  &lt;NA&gt;               &lt;NA&gt;        SLAMS
## 2             2001-03-08                  &lt;NA&gt;               &lt;NA&gt;          EPA
##           networks monitoring_agency_code
## 1 CSN SUPPLEMENTAL                   0520
## 2          IMPROVE                   0745
##                                            monitoring_agency si_id latitude
## 1 Indiana Depart Of Environ Management/Office Of Air Quality  4388 41.58550
## 2                                      National Park Service 93130 38.53465
##   longitude datum lat_lon_accuracy elevation probe_height pl_probe_location
## 1 -87.47449 WGS84               20       188           NA              &lt;NA&gt;
## 2 -86.26037 WGS84                5       282           NA              &lt;NA&gt;
##                                   local_site_name
## 1 Hammond- Purdue/ Powers Bldg. Purdue University
## 2                                            &lt;NA&gt;
##                                              address state_name county_name
## 1 PURDUE UNIV CALUMET-POWERS BUILDING 2200 169th St.    Indiana        Lake
## 2                                            Livonia    Indiana  Washington
##       city_name cbsa_code                          cbsa_name csa_code
## 1       Hammond     16980 Chicago-Naperville-Elgin, IL-IN-WI      176
## 2 Not in a City     31140 Louisville/Jefferson County, KY-IN      350
##                                                     csa_name tribal_code
## 1                               Chicago-Naperville, IL-IN-WI        &lt;NA&gt;
## 2 Louisville/Jefferson County--Elizabethtown--Madison, KY-IN        &lt;NA&gt;
##   tribe_name
## 1       &lt;NA&gt;
## 2       &lt;NA&gt;</code></pre>
</div>
</div>
<div id="querying-for-faa-data-in-r" class="section level2" number="1.2">
<h2 number="1.2"><span class="header-section-number">1.2</span> Querying for FAA Data in R</h2>
<p>FAA weather data gathered from the <a href="https://en.wikipedia.org/wiki/Automated_airport_weather_station">Automated Surface Observing System (ASOS)</a> can be imported using the <strong>riem</strong> package. This package, created by <a href="https://ropensci.org/">ROpenSci</a> queries weather data from the <a href="https://mesonet.agron.iastate.edu/ASOS/">Iowa Environmental Mesonet</a>, an online portal for international ASOS data maintained by Iowa State University. First, let’s load the package.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="weather-data-preparation-and-wrangling.html#cb25-1"></a>devtools<span class="op">::</span><span class="kw">install_github</span>(<span class="st">&#39;ropensci/riem&#39;</span>)</span></code></pre></div>
<pre><code>## Skipping install of &#39;riem&#39; from a github remote, the SHA1 (b2f2e412) has not changed since last install.
##   Use `force = TRUE` to force installation</code></pre>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="weather-data-preparation-and-wrangling.html#cb27-1"></a><span class="kw">library</span>(riem,<span class="dt">quietly =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<div id="simple-data-query" class="section level3" number="1.2.1">
<h3 number="1.2.1"><span class="header-section-number">1.2.1</span> Simple Data Query</h3>
<p>Below is an R code snippet that performs the simplest weather data query possible in the <strong>riem</strong> package. It specifies a particular weather station using an airport code and a date range to query for. The output is a tibble table of raw ASOS weather data.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="weather-data-preparation-and-wrangling.html#cb28-1"></a>SFO.weather =<span class="st"> </span><span class="kw">riem_measures</span>(<span class="dt">station =</span> <span class="st">&#39;KSFO&#39;</span>, <span class="dt">date_start =</span> <span class="st">&quot;2014-01-01&quot;</span>, <span class="dt">date_end =</span> <span class="st">&#39;2014-01-02&#39;</span>)</span>
<span id="cb28-2"><a href="weather-data-preparation-and-wrangling.html#cb28-2"></a><span class="kw">head</span>(SFO.weather)</span></code></pre></div>
<pre><code>## # A tibble: 6 x 31
##   station valid                 lon   lat  tmpf  dwpf  relh  drct  sknt  p01i
##   &lt;chr&gt;   &lt;dttm&gt;              &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 SFO     2014-01-01 00:56:00 -122.  37.6  54.0  43.0  66.3   290     8     0
## 2 SFO     2014-01-01 01:56:00 -122.  37.6  52.0  43.0  71.3   280     9     0
## 3 SFO     2014-01-01 02:56:00 -122.  37.6  51.1  44.1  76.8   290     8     0
## 4 SFO     2014-01-01 03:56:00 -122.  37.6  48.9  37.9  65.7     0     0     0
## 5 SFO     2014-01-01 04:56:00 -122.  37.6  50    39.9  68.2     0     0     0
## 6 SFO     2014-01-01 05:56:00 -122.  37.6  48.9  37.0  63.4     0     0     0
## # … with 21 more variables: alti &lt;dbl&gt;, mslp &lt;dbl&gt;, vsby &lt;dbl&gt;, gust &lt;lgl&gt;,
## #   skyc1 &lt;chr&gt;, skyc2 &lt;chr&gt;, skyc3 &lt;chr&gt;, skyc4 &lt;lgl&gt;, skyl1 &lt;dbl&gt;,
## #   skyl2 &lt;dbl&gt;, skyl3 &lt;dbl&gt;, skyl4 &lt;lgl&gt;, wxcodes &lt;lgl&gt;,
## #   ice_accretion_1hr &lt;lgl&gt;, ice_accretion_3hr &lt;lgl&gt;, ice_accretion_6hr &lt;lgl&gt;,
## #   peak_wind_gust &lt;lgl&gt;, peak_wind_drct &lt;lgl&gt;, peak_wind_time &lt;lgl&gt;,
## #   feel &lt;dbl&gt;, metar &lt;chr&gt;</code></pre>
<p>The outputted table shows weather data for a 24-hour period on January 1st, 2014 at the San Francisco International Airport. The <em>valid</em> column species when each weather report was generated, typically at 1-hour intervals. The <em>tmpf</em> and <em>dwpf</em> columns give the ambient air temperature and dew point in Fahrenheit (ºF). Other important variables in our project include air pressure (<em>alti</em>), measured in inches of mercury (in.Hg), and visibility (<em>vsby</em>) in miles. For more information on all available varibles, see Iowa State’s <a href="https://mesonet.agron.iastate.edu/request/download.phtml">Documentation</a>.</p>
<p>Next, we will apply this function at a large scare across multiple sensors and timescales.</p>
</div>
<div id="selecting-which-sensors-to-query" class="section level3" number="1.2.2">
<h3 number="1.2.2"><span class="header-section-number">1.2.2</span> Selecting Which Sensors to Query</h3>
<p>The FAA collects weather data at hourly intervals for each meteorological station, with some stations providing half-hour intervals. Even querying for short periods of time can yield large amounts of data. To optimise performance, we want to only query data from stations in our study area.</p>
<div id="finding-sensors-by-state" class="section level4 unnumbered" number="">
<h4 class="unnumbered" number="">Finding Sensors by State</h4>
<p>In our project, we focus on certain counties in Illinois, Indiana, and Wisconsin, so we are interested in finding the sensors within that study area. The first step is to query the locations of all weather stations in Illinois, Indiana, and Wisconsin using the <strong>reim</strong> package. In the example below, we query for sensors in the Illinois ASOS sensor network.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="weather-data-preparation-and-wrangling.html#cb30-1"></a><span class="kw">riem_stations</span>(<span class="dt">network =</span> <span class="st">&#39;IL_ASOS&#39;</span>)</span></code></pre></div>
<pre><code>## # A tibble: 61 x 4
##    id    name               lon   lat
##    &lt;chr&gt; &lt;chr&gt;            &lt;dbl&gt; &lt;dbl&gt;
##  1 ALN   ALTON/ST LOUIS R -90.0  38.9
##  2 BMI   BLOOMINGTON/NORM -88.9  40.5
##  3 CPS   CAHOKIA/ST LOUIS -90.2  38.6
##  4 CIR   Cairo            -89.2  37.1
##  5 MDH   CARBONDALE/MURPH -89.2  37.8
##  6 CUL   Carmi            -88.1  38.1
##  7 ENL   CENTRALIA        -89.1  38.5
##  8 CMI   CHAMPAIGN/URBANA -88.3  40.0
##  9 MDW   CHICAGO          -87.8  41.8
## 10 ARR   CHICAGO/AURORA   -88.5  41.8
## # … with 51 more rows</code></pre>
<p>To query for data across multiple states, we are going the apply the <em>riem_stations</em> function to a list of weather station networks, as shown below.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="weather-data-preparation-and-wrangling.html#cb32-1"></a>networks =<span class="st"> </span><span class="kw">list</span>(<span class="st">&#39;IL_ASOS&#39;</span>, <span class="st">&#39;IN_ASOS&#39;</span>, <span class="st">&#39;WI_ASOS&#39;</span>)</span>
<span id="cb32-2"><a href="weather-data-preparation-and-wrangling.html#cb32-2"></a></span>
<span id="cb32-3"><a href="weather-data-preparation-and-wrangling.html#cb32-3"></a><span class="kw">library</span>(dplyr, <span class="dt">quietly =</span> <span class="ot">TRUE</span>)</span>
<span id="cb32-4"><a href="weather-data-preparation-and-wrangling.html#cb32-4"></a>station.locs =<span class="st"> </span><span class="kw">lapply</span>(networks, riem<span class="op">::</span>riem_stations) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb32-5"><a href="weather-data-preparation-and-wrangling.html#cb32-5"></a><span class="st">        </span><span class="kw">do.call</span>(rbind, .) <span class="co"># Creates a single data table as output</span></span>
<span id="cb32-6"><a href="weather-data-preparation-and-wrangling.html#cb32-6"></a></span>
<span id="cb32-7"><a href="weather-data-preparation-and-wrangling.html#cb32-7"></a><span class="kw">head</span>(station.locs)</span></code></pre></div>
<pre><code>## # A tibble: 6 x 4
##   id    name               lon   lat
##   &lt;chr&gt; &lt;chr&gt;            &lt;dbl&gt; &lt;dbl&gt;
## 1 ALN   ALTON/ST LOUIS R -90.0  38.9
## 2 BMI   BLOOMINGTON/NORM -88.9  40.5
## 3 CPS   CAHOKIA/ST LOUIS -90.2  38.6
## 4 CIR   Cairo            -89.2  37.1
## 5 MDH   CARBONDALE/MURPH -89.2  37.8
## 6 CUL   Carmi            -88.1  38.1</code></pre>
<p>Note: You can find a list of state abbreviations by typing ‘state.abb’ in your R console.</p>
</div>
<div id="converting-latitude-and-longitude-coordinates-to-spatial-data" class="section level4 unnumbered" number="">
<h4 class="unnumbered" number="">Converting Latitude and Longitude Coordinates to Spatial Data</h4>
<p>The data tables returned by the <strong>riem</strong> package must be converted to spatial data to determine which sensors are located in the study area. Since the lon/lat coordinates are already provided, the data table is easily converted to a spatial <em>sf</em> object.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="weather-data-preparation-and-wrangling.html#cb34-1"></a>station.locs.sf =<span class="st"> </span>sf<span class="op">::</span><span class="kw">st_as_sf</span>(station.locs, <span class="dt">coords =</span> <span class="kw">c</span>(<span class="st">&quot;lon&quot;</span>, <span class="st">&quot;lat&quot;</span>), <span class="dt">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb34-2"><a href="weather-data-preparation-and-wrangling.html#cb34-2"></a></span>
<span id="cb34-3"><a href="weather-data-preparation-and-wrangling.html#cb34-3"></a><span class="co"># Plot stations and study area boundaries to verify that the correct sensors were selected</span></span>
<span id="cb34-4"><a href="weather-data-preparation-and-wrangling.html#cb34-4"></a><span class="kw">plot</span>(station.locs.sf<span class="op">$</span>geometry)</span>
<span id="cb34-5"><a href="weather-data-preparation-and-wrangling.html#cb34-5"></a><span class="kw">plot</span>(sf<span class="op">::</span><span class="kw">st_read</span>(<span class="st">&#39;https://uchicago.box.com/shared/static/uw0srt8nyyjfqo6l0dv07cyskwmv6r50.geojson&#39;</span>, <span class="dt">quiet =</span> <span class="ot">TRUE</span>)<span class="op">$</span>geometry, <span class="dt">border =</span> <span class="st">&#39;red&#39;</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/csv.to.spatial-1.png" width="672" /></p>
<p>We plot to results to verify that our query and data conversion process worked correctly. For reference, the boundaires of the study area is outlined in red.</p>
</div>
<div id="selecting-sensors-within-a-study-area" class="section level4 unnumbered" number="">
<h4 class="unnumbered" number="">Selecting Sensors within a Study Area</h4>
<p>Next, we perform a spatial join to only keep the points located within the boundaries of our study area polygons. The spatial join is completed by the <strong>sf</strong> package, as shown below. For more information regarding spatial joins and spatial predicates, please see <a href="https://gisgeography.com/spatial-join/">this</a> helpful blog post by GISgeography.com.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="weather-data-preparation-and-wrangling.html#cb35-1"></a><span class="co"># Loading study area boundaries</span></span>
<span id="cb35-2"><a href="weather-data-preparation-and-wrangling.html#cb35-2"></a>study.area =<span class="st"> </span>sf<span class="op">::</span><span class="kw">st_read</span>(<span class="st">&#39;https://uchicago.box.com/shared/static/uw0srt8nyyjfqo6l0dv07cyskwmv6r50.geojson&#39;</span>, <span class="dt">quiet =</span> <span class="ot">TRUE</span>)</span>
<span id="cb35-3"><a href="weather-data-preparation-and-wrangling.html#cb35-3"></a></span>
<span id="cb35-4"><a href="weather-data-preparation-and-wrangling.html#cb35-4"></a>study.sensors =<span class="st"> </span>sf<span class="op">::</span><span class="kw">st_join</span>(station.locs.sf, study.area, <span class="dt">left =</span> <span class="ot">FALSE</span>)</span>
<span id="cb35-5"><a href="weather-data-preparation-and-wrangling.html#cb35-5"></a></span>
<span id="cb35-6"><a href="weather-data-preparation-and-wrangling.html#cb35-6"></a><span class="co"># Verify Spatial Join by Plotting</span></span>
<span id="cb35-7"><a href="weather-data-preparation-and-wrangling.html#cb35-7"></a><span class="kw">plot</span>(study.area<span class="op">$</span>geometry, <span class="dt">border =</span> <span class="st">&#39;red&#39;</span>)</span>
<span id="cb35-8"><a href="weather-data-preparation-and-wrangling.html#cb35-8"></a><span class="kw">plot</span>(study.sensors<span class="op">$</span>geometry, <span class="dt">add =</span> <span class="ot">TRUE</span>)</span>
<span id="cb35-9"><a href="weather-data-preparation-and-wrangling.html#cb35-9"></a><span class="kw">title</span>(<span class="st">&#39;Weather Stations Within the Study Area&#39;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/sensor.join-1.png" width="672" /></p>
<p>Now that we have a dataset of which weather stations we are interested in, we can query for the weather data associated with each station.</p>
</div>
</div>
<div id="querying-weather-data-for-multiple-stations" class="section level3" number="1.2.3">
<h3 number="1.2.3"><span class="header-section-number">1.2.3</span> Querying Weather Data for Multiple Stations</h3>
<p>Again we use the <em>lapply</em> function in base R to execute the <em>riem_measures</em> function on a list of sensor IDs. This allows us to iterativelt query for weather data from each individual sensor in a list. In the code snippet below, we take the study sensors obtained previously and query for a single day’s worth of weather data.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="weather-data-preparation-and-wrangling.html#cb36-1"></a><span class="kw">library</span>(dplyr, <span class="dt">quietly =</span> <span class="ot">TRUE</span>)</span>
<span id="cb36-2"><a href="weather-data-preparation-and-wrangling.html#cb36-2"></a></span>
<span id="cb36-3"><a href="weather-data-preparation-and-wrangling.html#cb36-3"></a>weather.data =<span class="st"> </span><span class="kw">lapply</span>(study.sensors<span class="op">$</span>id, <span class="cf">function</span>(x){riem<span class="op">::</span><span class="kw">riem_measures</span>(x, <span class="dt">date_start =</span> <span class="st">&quot;2014-01-01&quot;</span>, <span class="dt">date_end =</span> <span class="st">&quot;2014-01-02&quot;</span>)}) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb36-4"><a href="weather-data-preparation-and-wrangling.html#cb36-4"></a><span class="st">        </span><span class="kw">do.call</span>(rbind, .) <span class="co"># Creates a single data table as output</span></span></code></pre></div>
<pre><code>## Warning: No results for this query.

## Warning: No results for this query.

## Warning: No results for this query.</code></pre>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="weather-data-preparation-and-wrangling.html#cb38-1"></a><span class="kw">head</span>(weather.data)</span></code></pre></div>
<pre><code>## # A tibble: 6 x 31
##   station valid                 lon   lat  tmpf  dwpf  relh  drct  sknt   p01i
##   &lt;chr&gt;   &lt;dttm&gt;              &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
## 1 MDW     2014-01-01 00:49:00 -87.8  41.8  12.2  8.6   85.2   230     3 0.01  
## 2 MDW     2014-01-01 00:51:00 -87.8  41.8  12.9  8.96  83.8   230     3 0.01  
## 3 MDW     2014-01-01 01:51:00 -87.8  41.8  12.9  8.96  83.8   280     3 0.0001
## 4 MDW     2014-01-01 02:27:00 -87.8  41.8  14    8.6   78.7   340     4 0.01  
## 5 MDW     2014-01-01 02:51:00 -87.8  41.8  14    8.96  80.0   340     5 0.02  
## 6 MDW     2014-01-01 03:08:00 -87.8  41.8  14   10.4   85.3   360     7 0.0001
## # … with 21 more variables: alti &lt;dbl&gt;, mslp &lt;dbl&gt;, vsby &lt;dbl&gt;, gust &lt;dbl&gt;,
## #   skyc1 &lt;chr&gt;, skyc2 &lt;chr&gt;, skyc3 &lt;chr&gt;, skyc4 &lt;lgl&gt;, skyl1 &lt;dbl&gt;,
## #   skyl2 &lt;dbl&gt;, skyl3 &lt;dbl&gt;, skyl4 &lt;lgl&gt;, wxcodes &lt;chr&gt;,
## #   ice_accretion_1hr &lt;dbl&gt;, ice_accretion_3hr &lt;lgl&gt;, ice_accretion_6hr &lt;dbl&gt;,
## #   peak_wind_gust &lt;lgl&gt;, peak_wind_drct &lt;lgl&gt;, peak_wind_time &lt;lgl&gt;,
## #   feel &lt;dbl&gt;, metar &lt;chr&gt;</code></pre>
<div id="missing-weather-stations" class="section level4 unnumbered" number="">
<h4 class="unnumbered" number="">Missing Weather Stations</h4>
<p>Some weather stations are unable to provide data during the requested time period, so a warning message is returned to the R console. You can see which ones are not active by comparing the <em>study.sensors</em> IDs and the <em>weather.data</em> station IDs, as shown below.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="weather-data-preparation-and-wrangling.html#cb40-1"></a><span class="kw">which</span>(<span class="op">!</span>(study.sensors<span class="op">$</span>id <span class="op">%in%</span><span class="st"> </span>weather.data<span class="op">$</span>station)) <span class="op">%&gt;%</span><span class="st"> </span>study.sensors[.,]</span></code></pre></div>
<pre><code>## Simple feature collection with 3 features and 10 fields
## geometry type:  POINT
## dimension:      XY
## bbox:           xmin: -88.3726 ymin: 41.8588 xmax: -87.6079 ymax: 42.7972
## epsg (SRID):    4326
## proj4string:    +proj=longlat +datum=WGS84 +no_defs
## # A tibble: 3 x 11
##   id    name                   geometry STATE CWA   COUNTYNAME FIPS  TIME_ZONE
##   &lt;chr&gt; &lt;chr&gt;               &lt;POINT [°]&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt;      &lt;fct&gt; &lt;fct&gt;    
## 1 CGX   &quot;CHI…        (-87.6079 41.8588) IL    LOT   Cook       17031 C        
## 2 06C   &quot;Chi…        (-88.1012 41.9893) IL    LOT   DuPage     17043 C        
## 3 57C   &quot;Eas…        (-88.3726 42.7972) WI    MKX   Walworth   55127 C        
## # … with 3 more variables: FE_AREA &lt;fct&gt;, LON &lt;dbl&gt;, LAT &lt;dbl&gt;</code></pre>
</div>
<div id="querying-large-weather-datasets" class="section level4 unnumbered" number="">
<h4 class="unnumbered" number="">Querying Large Weather Datasets</h4>
<p>Use caution when querying for a large amount of data. Data tables can easily become unwieldy after querying for a large number of weather stations across a wide time scale. The code snippet below downloads all ASOS weather data for sensors in our study area from January 1st 2014 to December 31st 2018. It has approximately 4.8 Million records and takes 6-10 minutes to download.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="weather-data-preparation-and-wrangling.html#cb42-1"></a>weather.data =<span class="st"> </span><span class="kw">lapply</span>(study.sensors<span class="op">$</span>id, <span class="cf">function</span>(x){riem<span class="op">::</span><span class="kw">riem_measures</span>(x, <span class="dt">date_start =</span> <span class="st">&quot;2014-01-01&quot;</span>, <span class="dt">date_end =</span> <span class="st">&quot;2018-12-31&quot;</span>)}) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb42-2"><a href="weather-data-preparation-and-wrangling.html#cb42-2"></a><span class="st">        </span><span class="kw">do.call</span>(rbind, .) <span class="co"># Creates a single data table as output</span></span>
<span id="cb42-3"><a href="weather-data-preparation-and-wrangling.html#cb42-3"></a></span>
<span id="cb42-4"><a href="weather-data-preparation-and-wrangling.html#cb42-4"></a><span class="kw">which</span>(<span class="op">!</span>(study.sensors<span class="op">$</span>id <span class="op">%in%</span><span class="st"> </span>weather.data<span class="op">$</span>station)) <span class="op">%&gt;%</span><span class="st"> </span>study.sensors[.,]</span></code></pre></div>
</div>
</div>
</div>
<div id="using-weather-data-to-interpolate-a-raster-surface" class="section level2" number="1.3">
<h2 number="1.3"><span class="header-section-number">1.3</span> Using Weather Data to Interpolate a Raster Surface</h2>
<p>To refine our models, we need to know or estimate meteorological variables across our entire study area. However, the downloaded weather data is only accurate at the exact sensor location where the measurement was taken. Therefore, we propose to linearly interpolate meteorological variables. The method used is an Inverse Distance Weighting for a raster resolution of 1 km, implemented in R as described below.</p>
<div id="your-first-interpolation" class="section level3" number="1.3.1">
<h3 number="1.3.1"><span class="header-section-number">1.3.1</span> Your First Interpolation</h3>
<p>This section describes how to create interpolated raster surfaces using the purpose-built <strong>sensor2raster</strong> package. First, let’s download and install the package.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="weather-data-preparation-and-wrangling.html#cb43-1"></a>devtools<span class="op">::</span><span class="kw">install_url</span>(<span class="st">&#39;https://uchicago.box.com/shared/static/u57vxg90ytieu86ow3m8xats3ebmfek4.tar.gz&#39;</span>, <span class="dt">quiet =</span> <span class="ot">TRUE</span>)</span>
<span id="cb43-2"><a href="weather-data-preparation-and-wrangling.html#cb43-2"></a><span class="kw">library</span>(sensor2raster)</span></code></pre></div>
<div id="workflow-execution" class="section level4 unnumbered" number="">
<h4 class="unnumbered" number="">Workflow Execution</h4>
<p>Next, we run the <em>Sensor.to.Raster</em> function on a sample EPA dataset of PM2.5 readings across Indiana Illinois, and Wisconsin in 2017. The function takes the raw output from an EPA or FAA data query, a data type (‘EPA’ or ‘FAA’ only) to perform the IDW analysis. An input of county boundaries defines the extent of the raster output. Meanwhile, the reference.grid input allows the user to input a vector-format grid to improve the readability of the output.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="weather-data-preparation-and-wrangling.html#cb44-1"></a>raster =<span class="st"> </span><span class="kw">Sensor.to.Raster</span>(<span class="dt">Sensor.data =</span> sample.data, </span>
<span id="cb44-2"><a href="weather-data-preparation-and-wrangling.html#cb44-2"></a>                          <span class="dt">data.type =</span> <span class="st">&#39;EPA&#39;</span>, </span>
<span id="cb44-3"><a href="weather-data-preparation-and-wrangling.html#cb44-3"></a>                          <span class="dt">reference.grid =</span> km.grid, </span>
<span id="cb44-4"><a href="weather-data-preparation-and-wrangling.html#cb44-4"></a>                          <span class="dt">counties =</span> sample.counties)</span></code></pre></div>
<pre><code>## Wrangling EPA Data</code></pre>
<pre><code>## Aggregating Data to Monthly and Quarterly Scales</code></pre>
<pre><code>## Creating IDW Surface for each Month and Quarter between 2017 and 2017</code></pre>
<pre><code>## Registered S3 method overwritten by &#39;xts&#39;:
##   method     from
##   as.zoo.xts zoo</code></pre>
<pre><code>## [inverse distance weighted interpolation]
## [inverse distance weighted interpolation]
## [inverse distance weighted interpolation]
## [inverse distance weighted interpolation]
## [inverse distance weighted interpolation]
## [inverse distance weighted interpolation]
## [inverse distance weighted interpolation]
## [inverse distance weighted interpolation]
## [inverse distance weighted interpolation]
## [inverse distance weighted interpolation]
## [inverse distance weighted interpolation]
## [inverse distance weighted interpolation]
## [inverse distance weighted interpolation]
## [inverse distance weighted interpolation]
## [inverse distance weighted interpolation]
## [inverse distance weighted interpolation]</code></pre>
<pre><code>## Converting Raster Grid to Vector Grid</code></pre>
<pre><code>## Finished! Monthly Data is the first element in outputted list, Quarterly is the 2nd element</code></pre>
</div>
<div id="output-interpretation" class="section level4 unnumbered" number="">
<h4 class="unnumbered" number="">Output Interpretation</h4>
<p>The <em>Sensor.to.Raster</em> function outputs four objects in a list. The first two elements contain Vector data products at Monthly and Quarterly time scales. The last two elements contain the equivalent product in Raster format.</p>
<div id="raster-product" class="section level5 unnumbered" number="">
<h5 class="unnumbered" number="">Raster Product</h5>
<p>Below is the sample Raster output for the 1st Quarter and 1st Month of 2017. Notice how multiple list objects are subsetted in the ouput of <em>Sensor.to.Raster</em></p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="weather-data-preparation-and-wrangling.html#cb52-1"></a>raster<span class="op">::</span><span class="kw">plot</span>(raster<span class="op">$</span>Quarterly_Raster_Data<span class="op">$</span>Q1<span class="fl">.2017</span>, <span class="dt">main =</span> <span class="st">&#39;Average Observed PM2.5 Levels in Q1 2017&#39;</span>)</span>
<span id="cb52-2"><a href="weather-data-preparation-and-wrangling.html#cb52-2"></a>sp<span class="op">::</span><span class="kw">plot</span>(sample.counties, <span class="dt">add =</span> <span class="ot">TRUE</span>) <span class="co"># Adding county boundaries for reference</span></span></code></pre></div>
<p><img src="_main_files/figure-html/sensor.to.raster.results1-1.png" width="672" /></p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="weather-data-preparation-and-wrangling.html#cb53-1"></a>raster<span class="op">::</span><span class="kw">plot</span>(raster<span class="op">$</span>Monthly_Raster_Data<span class="op">$</span>M1<span class="fl">.2017</span>, <span class="dt">main =</span> <span class="st">&#39;Average Observed PM2.5 Levels in Jan 2017&#39;</span>)</span>
<span id="cb53-2"><a href="weather-data-preparation-and-wrangling.html#cb53-2"></a>sp<span class="op">::</span><span class="kw">plot</span>(sample.counties, <span class="dt">add =</span> <span class="ot">TRUE</span>) <span class="co"># Adding county boundaries for reference</span></span></code></pre></div>
<p><img src="_main_files/figure-html/sensor.to.raster.results2-1.png" width="672" /></p>
</div>
<div id="vector-product" class="section level5 unnumbered" number="">
<h5 class="unnumbered" number="">Vector Product</h5>
<p>The same data is available is a vecorized grid format using the same grid specified by the user as an input. In this format, each month or quarter is represented by as a data field in the attribute table. This not only makes the data more compact, but also allows for improved data analysis. Below, we show the attribute table for the first five grid cells.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="weather-data-preparation-and-wrangling.html#cb54-1"></a><span class="kw">as.data.frame</span>(raster<span class="op">$</span>Monthly_Vector_Data[<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>,])</span></code></pre></div>
<pre><code>##    M1.2017  M2.2017  M3.2017  M4.2017  M5.2017  M6.2017  M7.2017  M8.2017
## 0 9.913034 9.488899 7.314569 7.433544 8.265008 8.204897 9.016285 9.733383
## 1 9.914292 9.489582 7.315106 7.433813 8.265065 8.204830 9.016273 9.732876
## 2 9.915646 9.490298 7.315677 7.434110 8.265130 8.204779 9.016296 9.732355
## 3 9.917095 9.491049 7.316284 7.434434 8.265203 8.204744 9.016353 9.731820
## 4 9.918642 9.491834 7.316926 7.434787 8.265284 8.204725 9.016446 9.731269
##    M9.2017 M10.2017 M11.2017 M12.2017
## 0 10.00584 7.037685 8.103771 8.165271
## 1 10.00575 7.037727 8.103471 8.165401
## 2 10.00563 7.037752 8.103176 8.165566
## 3 10.00548 7.037761 8.102886 8.165766
## 4 10.00530 7.037754 8.102601 8.166001</code></pre>
</div>
</div>
</div>
<div id="the-idw-workflow" class="section level3" number="1.3.2">
<h3 number="1.3.2"><span class="header-section-number">1.3.2</span> The IDW Workflow</h3>
<p>The workflow is designed to take time-series data input for a <strong>single</strong> variable from a multitude of either EPA or FAA ASOS sensors, and create IDW surfaces at monthly and quarterly timescales. The final data product models the intensity of the chosen variable across a wide area.</p>
<p>For example, this workflow can take ASOS Temperature data gathered from multiple sensors across a wide-area and predict the temperature in each location across the area, even if a sensor is not located there.</p>
<p>The entire workflow is divided into five helper functions that are each called in sucession by the larger <em>Sensor.to.Raster</em> function. Three functions act upon the EPA or FAA data to wrangle it into an approprite format for the IDW interpolation. The interpolation is handeled by another helper function based off the <em>idw</em> function from the <strong>gstat</strong> package. Finally, the data is post-processed into manageble vector and raster products.</p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="index.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
